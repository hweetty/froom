<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" type="text/css" href="style.css"/>
    <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDSuV6OH1F2hdbKNd_kH2nfKrS2-nvEWYg&sensor=false">
    </script>
  </head>
  <body>
    <div>
    <div id="map-canvas"/>
    </div>
    <div id="clock">
    <div id="clock-header">
        <input id="clock-textfield">
    </div>

<!-- :( pretty ugly. still beats my previous js code :p-->
<div id="free-room-template" style=" position:absolute; left:-10000px; top: -10000px">
    <div style="height: %height%px" class="clock-cell">
    <div style="top: %y%px" class="cell-main">
        <h1 class="cell-title">%building%</h1>
        <h2 class="cell-num-free %colour%">%rooms.length%</h2>
    </div>
    <p class="cell-rooms-list">%rooms%</p>
    </div>
</div>

    <div id="clock-table">
        <!-- 
        <div class="clock-cell">
        <h1 class="cell-title">MC</h1>
        <h2 class="cell-num-free">42</h2>
        <p class="cell-rooms-list">123,4556,1232,4141, 4065</p>
        </div>
        <div class="clock-cell">
        <h1 class="cell-title">RCH</h1>
        <h2 class="cell-num-free">42</h2>
        <p class="cell-rooms-list">123,4556,1232,4141, 4065</p>
        </div>
        <div class="clock-cell">
        <h1 class="cell-title">ABCD</h1>
        <h2 class="cell-num-free">42</h2>
        <p class="cell-rooms-list">123,4556,1232,4141, 4065</p>
        </div>
        <div class="clock-cell">
        <h1 class="cell-title">MC</h1>
        <h2 class="cell-num-free">42</h2>
        <p class="cell-rooms-list">123,4556,1232,4141, 4065</p> -->
    </div>
    <div id="clock-footer">
        <label id="clock-total" class="green">1337</label><label> rooms currently free</label>
    </div>
    </div>

<script type="text/javascript">

var FREE_ROOMS = "FREE_ROOMS";

var free_room_template = document.getElementById("free-room-template").innerHTML;

// My vars
var _baseURL = "/1/";
var _freeRooms = [];

updateData();


function receivedData (data)
{
    if (!data || !data.success)
    {
        console.log("something went wrong :");
        console.log(data);
        return;
    }

    // Parse data and display it
    _freeRooms = data.data;
    updateUI (_freeRooms, FREE_ROOMS);
}

// Update sidebar UI
function updateUI (data, type)
{
    if (type == FREE_ROOMS)
    {
        console.log("updating free rooms with data:");
        console.log(data);

        // Array of Buildings -> Empty_Rooms
        var str = "";
        var total = 0;
        var keys = Object.keys(data);
        for (var i in keys)
        {
            var cellData = {
                building : keys[i],
                rooms    : data[keys[i]]
            }

            str += formatCell(cellData);
            total += cellData.rooms.length;
        }

        var clockTable = document.getElementById("clock-table");
        clockTable.innerHTML = str;
        document.getElementById("clock-total").innerHTML = total;
    }
}

// Ask server for data
function updateData (day, time)
{
    var url = _baseURL + "rooms/free?";

    if (day)
        url += "day=" + day + "&"; // Do some error checking...
    if (time)
        url += "time=asdfsafd" + time;

    GET(url, receivedData);
}

function formatCell (cellData)
{
    var str = "";

    var height = 80;
    if (cellData.rooms.length >= 25)
        height = 130;
    else if (cellData.rooms.length >= 20)
        height = 110;

    var y = (height - 77) / 2;

    var replace = {
        "%height%": height,
        "%y%": y,
        "%building%": cellData.building,
        "%colour%": "green",
        "%rooms.length%": cellData.rooms.length,
        "%rooms%": cellData.rooms.join(", ")
    };


    var s = free_room_template;
    var keys = Object.keys(replace);
    for (var i in keys)
    {
        var k = keys[i];
        s = s.replace (k, replace[k]);
    }

    // str += '<div style="height: ' + height +'px;" class="clock-cell">';
    // str += '<h1 class="cell-title">' +cellData.building+ '</h1>';
    
    // str += '<h2 class="cell-num-free">' +cellData.rooms.length+ '</h2>';

    // str += '<p class="cell-rooms-list">' +cellData.rooms.join(", ")+ '</p></div>';

    return s;
}

google.maps.event.addDomListener(window, 'load', function initialize() {
        var mapOptions = {
          center: new google.maps.LatLng(-34.397, 150.644),
          zoom: 8
        };
        var map = new google.maps.Map(document.getElementById("map-canvas"),
            mapOptions);
});

function GET (url, fn)
{
console.log ("requesting :" + url);

    var xmlhttp = new XMLHttpRequest();
    xmlhttp.onreadystatechange = function ()
    {
        if (xmlhttp.readyState == 4)
        {
            var resp = xmlhttp.responseText;
            fn (JSON.parse(resp));
        }
    };
    
    // Start the request
    xmlhttp.open("GET", url ,true);
    xmlhttp.send();
}
</script>


  </body>
</html>